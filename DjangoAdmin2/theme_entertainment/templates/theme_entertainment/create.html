{% extends "admin-dashboard/base.html" %}

{% block title %}{{ page_title }}{% endblock %}

{% block extracss %}
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<link href="https://unpkg.com/naive-ui@2.34.4/dist/index.css" rel="stylesheet">
<script src="https://kit.fontawesome.com/your-kit-code.js" crossorigin="anonymous"></script>

<style>
    /* Ë°®ÂñÆÊ®£Âºè */
    .n-form-item-label {
        font-weight: 500;
    }

    .n-input,
    .n-select,
    .n-date-picker {
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .n-button {
        transition: all 0.2s ease;
    }

    .n-button:hover {
        transform: translateY(-1px);
    }
</style>
{% endblock %}

{% block content %}
<!-- CSRF‰ª§Áâå -->
{% csrf_token %}

<div id="app" class="wrapper wrapper-content animated fadeInRight">
    <!-- Vue ÊáâÁî®Â∞áÂú®ÈÄôË£°Ê∏≤Êüì -->
</div>

<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="https://unpkg.com/naive-ui@2.34.4/dist/index.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
    const { createApp, ref, computed } = Vue;
    const {
        NLayout, NCard, NForm, NFormItem, NInput, NDatePicker, NTimePicker,
        NSelect, NUpload, NButton, NGrid, NGridItem, NSpace, NMessageProvider,
        useMessage
    } = naive;

    const app = createApp({
        components: {
            NLayout, NCard, NForm, NFormItem, NInput, NDatePicker, NTimePicker,
            NSelect, NUpload, NButton, NGrid, NGridItem, NSpace, NMessageProvider
        },
        setup() {
            // Ë°®ÂñÆËàáË®äÊÅØÁõ∏ÈóúÂèÉËÄÉ
            const formRef = ref(null);
            const message = ref(null);

            // Ë®äÊÅØÁ≥ªÁµ±ÂàùÂßãÂåñ
            const initMessageSystem = () => {
                if (message.value === null) {
                    message.value = useMessage();
                    console.log('Ë®äÊÅØÁ≥ªÁµ±ÂàùÂßãÂåñÂÆåÊàê');
                }
                return message.value;
            };

            // ÊéõËºâÂæåÁ´ãÂç≥ÂàùÂßãÂåñË®äÊÅØÁ≥ªÁµ±
            const initComponent = () => {
                setTimeout(initMessageSystem, 100);
            };

            // ËøîÂõûÂàóË°®È†ÅÈù¢
            const handleBack = () => {
                window.location.href = '/admin-dashboard/entertainment/activities/';
            };

            // Ë°®ÂñÆË≥áÊñô
            const formValue = ref({
                activity_name: '',
                description: '',
                location: '',
                address: '',
                organizer: '',
                source_url: '',
                date_range: null,
                start_time: null,
                end_time: null,
                ticket_price: '',
                activity_type: null,
                image: null,
                imageFile: null
            });

            // Ê¥ªÂãïÈ°ûÂûãÈÅ∏È†Ö
            const activityTypes = [
                { label: 'Â±ïË¶Ω', value: 'Â±ïË¶Ω' },
                { label: 'Ë°®Êºî', value: 'Ë°®Êºî' },
                { label: 'Èü≥Ê®ÇÊúÉ', value: 'Èü≥Ê®ÇÊúÉ' },
                { label: 'Êà≤Âäá', value: 'Êà≤Âäá' },
                { label: 'ÂÖ∂‰ªñ', value: 'ÂÖ∂‰ªñ' }
            ];

            // Ë°®ÂñÆÈ©óË≠âË¶èÂâá
            const rules = {
                activity_name: {
                    required: true,
                    message: 'Ë´ãËº∏ÂÖ•Ê¥ªÂãïÂêçÁ®±',
                    trigger: 'blur',
                    validator: (rule, value) => {
                        if (value && value.length > 30) {
                            return new Error('Ê¥ªÂãïÂêçÁ®±‰∏çËÉΩË∂ÖÈÅé30Â≠ó');
                        }
                        return true;
                    }
                },
                description: {
                    required: true,
                    message: 'Ë´ãËº∏ÂÖ•Ê¥ªÂãï‰ªãÁ¥π',
                    trigger: 'blur',
                    validator: (rule, value) => {
                        if (value && value.length > 500) {
                            return new Error('Ê¥ªÂãï‰ªãÁ¥π‰∏çËÉΩË∂ÖÈÅé500Â≠ó');
                        }
                        return true;
                    }
                },
                location: {
                    required: true,
                    message: 'Ë´ãËº∏ÂÖ•Ê¥ªÂãïÂú∞Èªû',
                    trigger: 'blur'
                },
                date_range: {
                    required: true,
                    message: 'Ë´ãÈÅ∏ÊìáÊ¥ªÂãïÊó•ÊúüÁØÑÂúç',
                    trigger: 'blur',
                    validator: (rule, value) => {
                        if (!value || !value[0] || !value[1]) {
                            return new Error('Ë´ãÈÅ∏ÊìáÂÆåÊï¥ÁöÑÊó•ÊúüÁØÑÂúç');
                        }
                        return true;
                    }
                },
                activity_type: {
                    required: true,
                    message: 'Ë´ãÈÅ∏ÊìáÊ¥ªÂãïÈ°ûÂûã',
                    trigger: 'change'
                },
                address: {
                    required: true,
                    message: 'Ë´ãËº∏ÂÖ•Ê¥ªÂãïË©≥Á¥∞Âú∞ÂùÄ',
                    trigger: 'blur'
                },
                organizer: {
                    required: true,
                    message: 'Ë´ãËº∏ÂÖ•‰∏ªËæ¶ÂñÆ‰ΩçÂêçÁ®±',
                    trigger: 'blur'
                }
            };

            // ===== ÂúñÁâáËôïÁêÜ =====
            // ËôïÁêÜÂúñÁâá‰∏äÂÇ≥
            const handleImageUpload = (options) => {
                const { file } = options;
                if (file.file) {
                    // ‰øùÂ≠òÊ™îÊ°àÁâ©‰ª∂
                    formValue.value.imageFile = file.file;

                    // Âª∫Á´ãÈ†êË¶ΩÁî®ÁöÑ base64
                    const reader = new FileReader();
                    reader.readAsDataURL(file.file);
                    reader.onload = () => {
                        formValue.value.image = reader.result;
                    };
                }
            };

            // ÂúñÁâáÈ†êË¶ΩÁãÄÊÖã
            const showImagePreview = computed(() => Boolean(formValue.value.image));

            // ===== Ë°®ÂñÆËôïÁêÜ =====
            // Êó•ÊúüÊ†ºÂºèÂåñËºîÂä©ÂáΩÊï∏
            const formatDate = (date) => {
                if (!date) return null;
                const d = new Date(date);
                return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
            };

            // UUID ÁîüÊàêÂáΩÊï∏
            const generateUUID = () => {
                const hexDigits = "0123456789abcdef";
                let uuid = "";
                for (let i = 0; i < 32; i++) {
                    // UUID v4 ÁâàÊú¨ÁöÑÁâπÂÆö‰ΩçÁΩÆÈúÄË¶ÅÁâπÂÆöÂÄº
                    if (i === 12) {
                        uuid += "4"; // ÁâàÊú¨4
                    } else if (i === 16) {
                        uuid += hexDigits[(Math.floor(Math.random() * 16) & 0x3) | 0x8]; // ËÆäÈ´î
                    } else {
                        uuid += hexDigits[Math.floor(Math.random() * 16)];
                    }
                }
                return uuid; // 32‰ΩçÂ≠óÁ¨¶Ôºå‰∏çÂê´ÈÄ£Â≠óÁ¨¶
            };

            // Áç≤Âèñ CSRF ‰ª§Áâå
            const getCsrfToken = () => {
                let csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
                if (!csrfToken) {
                    const csrfCookie = document.cookie
                        .split('; ')
                        .find(row => row.startsWith('csrftoken='));
                    if (csrfCookie) {
                        csrfToken = csrfCookie.split('=')[1];
                    }
                }
                console.log('‰ΩøÁî®ÁöÑCSRF‰ª§Áâå:', csrfToken);
                return csrfToken;
            };

            // È°ØÁ§∫Êìç‰ΩúÁµêÊûúË®äÊÅØ
            const showResultMessage = (success, data) => {
                // Á¢∫‰øùË®äÊÅØÁ≥ªÁµ±Â∑≤ÂàùÂßãÂåñ
                const msgInstance = initMessageSystem();
                const activityName = data.activity_name || 'Êñ∞Ê¥ªÂãï';
                const redirectUrl = data.redirect_url || `${window.location.origin}/admin-dashboard/entertainment/activities/`;

                // ÊàêÂäüË®äÊÅØÂÖßÂÆπ
                const successTitle = `Ê¥ªÂãï„Äå${activityName}„ÄçÂª∫Á´ãÊàêÂäüÔºÅ`;
                const successContent = `Ê¥ªÂãïID: ${data.id}\nÂª∫Á´ãÊôÇÈñì: ${data.created_at}`;

                if (success) {
                    // ‰ΩøÁî® Naive UI Ë®äÊÅØÁ≥ªÁµ±
                    try {
                        msgInstance.success({
                            content: `${successTitle} ID: ${data.id}`,
                            duration: 3000,
                            closable: true
                        });
                    } catch (e) {
                        console.error('Naive UI Ë®äÊÅØÈ°ØÁ§∫Â§±Êïó:', e);
                    }

                    // ‰ΩøÁî®ÁÄèË¶ΩÂô®ÂÖßÂª∫ alert ‰ΩúÁÇ∫ÂÇôÁî®
                    alert(`${successTitle}\n\n${successContent}`);

                    // Ë©¢ÂïèÁî®Êà∂ÂæåÁ∫åÂãï‰Ωú
                    const confirmed = confirm('ÊòØÂê¶ËøîÂõûÊ¥ªÂãïÂàóË°®Ôºü');
                    if (confirmed) {
                        window.location.href = redirectUrl;
                    } else {
                        resetForm();
                    }
                } else {
                    // ÈåØË™§Ë®äÊÅØ
                    try {
                        msgInstance.error(data.message || 'Êìç‰ΩúÂ§±Êïó');
                    } catch (e) {
                        alert(`Êìç‰ΩúÂ§±Êïó: ${data.message || 'Êú™Áü•ÈåØË™§'}`);
                    }
                }
            };

            // Êèê‰∫§Ë°®ÂñÆËôïÁêÜ
            const handleSubmit = async (e) => {
                e.preventDefault();
                try {
                    // Ë°®ÂñÆÈ©óË≠â
                    await formRef.value?.validate();

                    // ÂøÖË¶ÅÊ¨Ñ‰ΩçÊ™¢Êü•
                    const requiredFields = ['activity_name', 'description', 'location', 'start_date', 'end_date'];

                    // ÂâµÂª∫ FormData Áî®ÊñºÊèê‰∫§
                    const formData = new FormData();

                    // ÁîüÊàê UUID
                    const generatedUUID = generateUUID();
                    console.log("ÁîüÊàêÁöÑUUID:", generatedUUID);

                    // Ê∫ñÂÇôË¶ÅÁôºÈÄÅÁöÑÊï∏Êìö
                    const submitData = {
                        uid: generatedUUID,
                        activity_name: formValue.value.activity_name,
                        description: formValue.value.description,
                        organizer: formValue.value.organizer || '',
                        address: formValue.value.address || '',
                        location: formValue.value.location,
                        start_date: formatDate(formValue.value.date_range?.[0]),
                        end_date: formatDate(formValue.value.date_range?.[1]),
                        latitude: null,
                        longitude: null,
                        ticket_price: formValue.value.ticket_price || '',
                        source_url: formValue.value.source_url || '',
                        image_url: ''
                    };

                    // È©óË≠âÂøÖÂ°´Ê¨Ñ‰Ωç
                    for (const field of requiredFields) {
                        if (!submitData[field]) {
                            throw new Error(`${field} ÊòØÂøÖÂ°´Ê¨Ñ‰Ωç`);
                        }
                    }

                    // Ë®≠ÁΩÆ UID
                    formData.append('uid', generatedUUID);

                    // Â∞áÂÖ∂‰ªñÊï∏ÊìöÊ∑ªÂä†Âà∞ FormData
                    Object.keys(submitData).forEach(key => {
                        if (key !== 'uid') {
                            formData.append(key, submitData[key]);
                        }
                    });

                    // Â¶ÇÊûúÊúâÂúñÁâáÊ™îÊ°àÔºåÊ∑ªÂä†Âà∞ FormData
                    if (formValue.value.imageFile) {
                        formData.append('image', formValue.value.imageFile);
                    }

                    // Áç≤Âèñ CSRF ‰ª§Áâå
                    const csrfToken = getCsrfToken();

                    // ÁôºÈÄÅ API Ë´ãÊ±Ç
                    try {
                        const response = await axios.post(
                            '/admin-dashboard/entertainment/activities/create/',
                            formData,
                            {
                                headers: {
                                    'X-CSRFToken': csrfToken,
                                    'Content-Type': 'multipart/form-data'
                                }
                            }
                        );

                        console.log('Response:', response.data);

                        if (response.data.status === 'success') {
                            // È°ØÁ§∫Êõ¥ÊòéÈ°ØÁöÑÊàêÂäüË®äÊÅØ
                            console.log('Ê¥ªÂãïÂª∫Á´ãÊàêÂäüÔºåÊ¥ªÂãïID:', response.data.id);
                            console.log('Ê¥ªÂãïÂª∫Á´ãÊôÇÈñì:', response.data.created_at);

                            // È°ØÁ§∫ÊàêÂäüË®äÊÅØ‰∏¶ËôïÁêÜÂæåÁ∫åÂãï‰Ωú
                            showResultMessage(true, response.data);
                        } else {
                            throw new Error(response.data.message || 'Âª∫Á´ãÊ¥ªÂãïÂ§±Êïó');
                        }
                    } catch (error) {
                        console.error('API Error:', error.response?.data || error);
                        showResultMessage(false, {
                            message: error.response?.data?.message || error.message || 'Âª∫Á´ãÊ¥ªÂãïÂ§±Êïó'
                        });
                    }
                } catch (error) {
                    console.error('Form Error:', error);
                    showResultMessage(false, { message: error.message || 'Ë°®ÂñÆÈ©óË≠âÂ§±Êïó' });
                }
            };

            // ÈáçÁΩÆË°®ÂñÆ
            const resetForm = () => {
                formValue.value = {
                    activity_name: '',
                    description: '',
                    location: '',
                    address: '',
                    organizer: '',
                    source_url: '',
                    date_range: null,
                    start_time: null,
                    end_time: null,
                    ticket_price: '',
                    activity_type: null,
                    image: null,
                    imageFile: null
                };
                formRef.value?.restoreValidation();
            };

            return {
                formRef,
                formValue,
                activityTypes,
                rules,
                handleSubmit,
                initMessageSystem,
                handleBack,
                resetForm,
                handleImageUpload,
                showImagePreview,
                initComponent
            };
        },
        template: `
        <n-message-provider>
            <n-layout class="p-6" @mounted="initComponent">
                <n-card class="mb-6">
                    <n-grid :cols="2">
                        <n-grid-item>
                            <h1 class="text-2xl font-bold mb-2">{{ page_title }}</h1>
                            <p class="text-gray-600">{{ page_description }}</p>
                        </n-grid-item>
                        <n-grid-item class="text-right">
                            <n-button type="default" @click="handleBack">
                                <template #icon>&#8592;</template>
                                ËøîÂõûÂàóË°®
                            </n-button>
                        </n-grid-item>
                    </n-grid>
                </n-card>

                <n-grid :x-gap="12" :cols="2">
                    <n-grid-item span="1">
                        <n-card title="Ê¥ªÂãïÂü∫Êú¨Ë≥áË®ä" class="mb-6">
                            <n-form ref="formRef" :model="formValue" :rules="rules">
                                <n-form-item label="Ê¥ªÂãïÂêçÁ®±" path="activity_name">
                                    <n-input
                                        v-model:value="formValue.activity_name"
                                        placeholder="Ë´ãËº∏ÂÖ•Ê¥ªÂãïÂêçÁ®±ÔºàÊúÄÂ§ö30Â≠óÔºâ"
                                        :maxlength="30"
                                        show-count
                                    />
                                </n-form-item>

                                <n-form-item label="‰∏ªËæ¶ÂñÆ‰Ωç" path="organizer">
                                    <n-input
                                        v-model:value="formValue.organizer"
                                        placeholder="Ë´ãËº∏ÂÖ•‰∏ªËæ¶ÂñÆ‰ΩçÂêçÁ®±"
                                    />
                                </n-form-item>

                                <n-form-item label="Ë´ãËº∏ÂÖ•Ê¥ªÂãï‰ªãÁ¥π" path="description">
                                    <n-input
                                        v-model:value="formValue.description"
                                        type="textarea"
                                        placeholder="Ë´ãËº∏ÂÖ•Ê¥ªÂãï‰ªãÁ¥πÔºàÊúÄÂ§ö500Â≠óÔºâ"
                                        :rows="4"
                                        :maxlength="500"
                                        show-count
                                        :autosize="{ minRows: 4, maxRows: 8 }"
                                    />
                                </n-form-item>

                                <n-form-item label="Ê¥ªÂãïÂú∞Èªû" path="location">
                                    <n-input v-model:value="formValue.location" placeholder="Ë´ãËº∏ÂÖ•Ê¥ªÂãïÂú∞Èªû"/>
                                </n-form-item>

                                <n-form-item label="Ê¥ªÂãïË©≥Á¥∞Âú∞ÂùÄ" path="address">
                                    <n-input v-model:value="formValue.address" placeholder="Ë´ãËº∏ÂÖ•Ê¥ªÂãïË©≥Á¥∞Âú∞ÂùÄ"/>
                                </n-form-item>

                                <n-grid :cols="2" :x-gap="12">
                                    <n-grid-item>
                                        <n-form-item label="Ê¥ªÂãïÊó•Êúü" path="date_range">
                                            <div style="max-width: 300px;">
                                                <n-date-picker
                                                    v-model:value="formValue.date_range"
                                                    type="daterange"
                                                    clearable
                                                    :disabled-date="(ts) => ts < Date.now() - 24 * 60 * 60 * 1000"
                                                    start-placeholder="ÈñãÂßãÊó•Êúü"
                                                    end-placeholder="ÁµêÊùüÊó•Êúü"
                                                    :default-time="['00:00:00', '23:59:59']"
                                                    style="width: 100%;"
                                                />
                                            </div>
                                        </n-form-item>
                                    </n-grid-item>
                                    <n-grid-item>
                                        <n-grid :cols="2" :x-gap="8">
                                            <n-grid-item>
                                                <n-form-item label="Ê¥ªÂãïËµ∑ÂßãÊôÇÈñì" path="start_time">
                                                    <n-time-picker
                                                        v-model:value="formValue.start_time"
                                                        clearable
                                                        format="HH:mm"
                                                        :minutes-step="5"
                                                        :minutes-options="[
                                                            '00', '05', '10', '15', '20', '25',
                                                            '30', '35', '40', '45', '50', '55'
                                                        ]"
                                                        :use-12-hours="false"
                                                        placement="top-start"
                                                        :is-hours-disabled="(hour) => false"
                                                        :is-minutes-disabled="(minute) => minute % 5 !== 0"
                                                        :actions="null"
                                                        style="width: 100%;"
                                                    />
                                                </n-form-item>
                                            </n-grid-item>
                                            <n-grid-item>
                                                <n-form-item label="Ê¥ªÂãïÁµêÊùüÊôÇÈñì" path="end_time">
                                                    <n-time-picker
                                                        v-model:value="formValue.end_time"
                                                        clearable
                                                        format="HH:mm"
                                                        :minutes-step="5"
                                                        :minutes-options="[
                                                            '00', '05', '10', '15', '20', '25',
                                                            '30', '35', '40', '45', '50', '55'
                                                        ]"
                                                        :use-12-hours="false"
                                                        placement="top-start"
                                                        :is-hours-disabled="(hour) => false"
                                                        :is-minutes-disabled="(minute) => minute % 5 !== 0"
                                                        :actions="null"
                                                        style="width: 100%;"
                                                    />
                                                </n-form-item>
                                            </n-grid-item>
                                        </n-grid>
                                    </n-grid-item>
                                </n-grid>
                            </n-form>
                        </n-card>
                    </n-grid-item>

                    <n-grid-item span="1">
                        <n-card title="Ê¥ªÂãïË©≥Á¥∞Ë®≠ÂÆö" class="mb-6">
                            <n-form ref="formRef" :model="formValue" :rules="rules">
                                <n-form-item label="Á•®ÂÉπË≥áË®ä">
                                    <n-input v-model:value="formValue.ticket_price" placeholder="Ë´ãËº∏ÂÖ•Á•®ÂÉπË≥áË®äÔºàËã•ÁÇ∫ÂÖçË≤ªÊ¥ªÂãïÂèØ‰∏çÂ°´Ôºâ"/>
                                </n-form-item>

                                <n-form-item label="Ê¥ªÂãïÈ°ûÂûã" path="activity_type">
                                    <n-select
                                        v-model:value="formValue.activity_type"
                                        :options="activityTypes"
                                        placeholder="Ë´ãÈÅ∏ÊìáÊ¥ªÂãïÈ°ûÂûã"
                                    />
                                </n-form-item>

                                <n-form-item label="Ê¥ªÂãïÁ∂≤ÂùÄ" path="source_url">
                                    <n-input v-model:value="formValue.source_url" placeholder="Ë´ãËº∏ÂÖ•Ê¥ªÂãïÂÆòÊñπÁ∂≤ÂùÄ"/>
                                </n-form-item>

                                <n-form-item label="Ê¥ªÂãïÂúñÁâá">
                                    <n-upload
                                        accept="image/*"
                                        :max="1"
                                        @change="handleImageUpload"
                                        list-type="image-card"
                                    >
                                        <n-button>‰∏äÂÇ≥ÂúñÁâá</n-button>
                                    </n-upload>
                                    <p class="text-sm text-gray-500 mt-2">Âª∫Ë≠∞Â∞∫ÂØ∏: 1200x630 ÂÉèÁ¥†ÔºåÊ™îÊ°àÂ§ßÂ∞è‰∏çË∂ÖÈÅé 2MBÔºåÂúñÁâáÂ∞á‰øùÂ≠òÂú®ÊúçÂãôÂô®‰∏ä</p>
                                </n-form-item>

                                <!-- ÂúñÁâáÈ†êË¶ΩÂçÄÂüü -->
                                <div v-if="formValue.image" class="mb-6 mt-2 border-t pt-4 border-gray-200">
                                    <h3 class="text-lg font-medium text-gray-700 mb-3">ÂúñÁâáÈ†êË¶Ω</h3>
                                    <div class="bg-gray-50 p-4 rounded-lg shadow-sm">
                                        <p class="text-xs text-gray-500 text-left mt-2">‰∏äÂÇ≥ÁöÑÂúñÁâáÂ∞áÈ°ØÁ§∫Âú®Ê¥ªÂãïË©≥ÊÉÖÈ†ÅÈù¢</p>
                                        <img :src="formValue.image" class="mx-auto" style="max-width: 100%; max-height: 300px; object-fit: contain;" />
                                    </div>
                                </div>

                                <div class="flex justify-between mt-6 space-x-12">
                                    <n-button type="primary" @click="handleSubmit" size="large">
                                        <template #icon>üíæ</template>
                                        Âª∫Á´ãÊ¥ªÂãï
                                    </n-button>
                                    <n-button type="error" @click="resetForm" size="large">
                                        <template #icon>üîÑ</template>
                                        ÈáçÁΩÆ
                                    </n-button>
                                </div>
                            </n-form>
                        </n-card>
                    </n-grid-item>
                </n-grid>
            </n-layout>
        </n-message-provider>
    `
    });

    app.mount('#app');
</script>
{% endblock %}