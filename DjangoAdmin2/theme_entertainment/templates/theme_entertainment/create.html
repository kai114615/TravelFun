{% extends "admin-dashboard/base.html" %}

{% block title %}{{ page_title }}{% endblock %}

{% block extracss %}
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<link href="https://unpkg.com/naive-ui@2.34.4/dist/index.css" rel="stylesheet">
<script src="https://kit.fontawesome.com/your-kit-code.js" crossorigin="anonymous"></script>
{% endblock %}

{% block content %}
<div id="app">
    <!-- Vue ÊáâÁî®Â∞áÂú®ÈÄôË£°Ê∏≤Êüì -->
</div>

<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="https://unpkg.com/naive-ui@2.34.4/dist/index.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
    const { createApp, ref } = Vue;
    const { NLayout, NCard, NForm, NFormItem, NInput, NDatePicker, NTimePicker, NSelect, NUpload, NButton, NGrid, NGridItem, NSpace, NMessageProvider, useMessage } = naive;

    const app = createApp({
        components: {
            NLayout, NCard, NForm, NFormItem, NInput, NDatePicker, NTimePicker, NSelect, NUpload, NButton, NGrid, NGridItem, NSpace, NMessageProvider
        },
        setup() {
            const handleBack = () => {
                window.location.href = '/admin-dashboard/entertainment/activities/';
            };

            const message = ref(null);
            const handleMessage = () => {
                message.value = useMessage();
            };
            const formRef = ref(null);
            const formValue = ref({
                activity_name: '',
                description: '',
                location: '',
                date_range: null,
                start_time: null,
                end_time: null,
                ticket_price: '',
                activity_type: null,
                image: null
            });

            const activityTypes = [
                { label: 'Â±ïË¶Ω', value: 'Â±ïË¶Ω' },
                { label: 'Ë°®Êºî', value: 'Ë°®Êºî' },
                { label: 'Èü≥Ê®ÇÊúÉ', value: 'Èü≥Ê®ÇÊúÉ' },
                { label: 'Êà≤Âäá', value: 'Êà≤Âäá' },
                { label: 'ÂÖ∂‰ªñ', value: 'ÂÖ∂‰ªñ' }
            ];

            const rules = {
                activity_name: {
                    required: true,
                    message: 'Ë´ãËº∏ÂÖ•Ê¥ªÂãïÂêçÁ®±',
                    trigger: 'blur',
                    validator: (rule, value) => {
                        if (value && value.length > 50) {
                            return new Error('Ê¥ªÂãïÂêçÁ®±‰∏çËÉΩË∂ÖÈÅé50Â≠ó');
                        }
                        return true;
                    }
                },
                description: {
                    required: true,
                    message: 'Ë´ãËº∏ÂÖ•Ê¥ªÂãï‰ªãÁ¥π',
                    trigger: 'blur',
                    validator: (rule, value) => {
                        if (value && value.length > 500) {
                            return new Error('Ê¥ªÂãï‰ªãÁ¥π‰∏çËÉΩË∂ÖÈÅé500Â≠ó');
                        }
                        return true;
                    }
                },
                location: {
                    required: true,
                    message: 'Ë´ãËº∏ÂÖ•Ê¥ªÂãïÂú∞Èªû',
                    trigger: 'blur'
                },
                date_range: {
                    required: true,
                    message: 'Ë´ãÈÅ∏ÊìáÊ¥ªÂãïÊó•ÊúüÁØÑÂúç',
                    trigger: 'blur',
                    validator: (rule, value) => {
                        if (!value || !value[0] || !value[1]) {
                            return new Error('Ë´ãÈÅ∏ÊìáÂÆåÊï¥ÁöÑÊó•ÊúüÁØÑÂúç');
                        }
                        return true;
                    }
                },
                activity_type: {
                    required: true,
                    message: 'Ë´ãÈÅ∏ÊìáÊ¥ªÂãïÈ°ûÂûã',
                    trigger: 'change'
                }
            };

            const handleSubmit = async (e) => {
        e.preventDefault();
                try {
                    // ÂÖàÈÄ≤Ë°åË°®ÂñÆÈ©óË≠â
                    await formRef.value?.validate();

                    // ËôïÁêÜÊó•ÊúüÊ†ºÂºè
                    const formatDate = (date) => {
                        if (!date) return null;
                        const d = new Date(date);
                        return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                    };

                    // ËôïÁêÜÊôÇÈñìÊ†ºÂºè
                    const formatTime = (time) => {
                        if (!time) return null;
                        return `${String(time.getHours()).padStart(2, '0')}:${String(time.getMinutes()).padStart(2, '0')}`;
                    };

                    // Ê∫ñÂÇôË¶ÅÁôºÈÄÅÁöÑÊï∏Êìö
                    const submitData = {
                        uid: Date.now().toString(), // ÁîüÊàêÂîØ‰∏ÄID
                        activity_name: formValue.value.activity_name,
                        description: formValue.value.description,
                        organizer: '', // ÂèØÁÇ∫Á©∫
                        address: formValue.value.location, // ‰ΩøÁî®location‰ΩúÁÇ∫address
                        location: formValue.value.location,
                        start_date: formatDate(formValue.value.date_range?.[0]),
                        end_date: formatDate(formValue.value.date_range?.[1]),
                        latitude: null,
                        longitude: null,
                        ticket_price: formValue.value.ticket_price || '',
                        source_url: '',
                        image_url: formValue.value.image || ''
                    };

                    // Ê™¢Êü•ÂøÖË¶ÅÊ¨Ñ‰Ωç
                    const requiredFields = ['activity_name', 'description', 'location', 'start_date', 'end_date'];
                    for (const field of requiredFields) {
                        if (!submitData[field]) {
                            throw new Error(`${field} ÊòØÂøÖÂ°´Ê¨Ñ‰Ωç`);
                        }
                    }

                    console.log('Submitting data:', submitData); // Áî®ÊñºË™øË©¶

                    try {
                        const response = await axios.post('/admin-dashboard/entertainment/activities/create/',
                            submitData,
                            {
            headers: {
                                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                                    'Content-Type': 'application/json'
                                }
                            }
                        );

                        console.log('Response:', response.data); // Áî®ÊñºË™øË©¶

                        if (response.data.status === 'success') {
                            message.value.success('Ê¥ªÂãïÂª∫Á´ãÊàêÂäü');
                            setTimeout(() => {
                                window.location.href = '/admin-dashboard/entertainment/activities/?sort=desc';
                            }, 1500);
                } else {
                            throw new Error(response.data.message || 'Âª∫Á´ãÊ¥ªÂãïÂ§±Êïó');
                        }
                    } catch (error) {
                        console.error('API Error:', error.response?.data || error);
                        message.value.error(error.response?.data?.message || error.message || 'Âª∫Á´ãÊ¥ªÂãïÂ§±Êïó');
                    }
                } catch (error) {
                    console.error('Form Error:', error);
                    message.value.error(error.message || 'Ë°®ÂñÆÈ©óË≠âÂ§±Êïó');
                }
            };

            const resetForm = () => {
                formValue.value = {
                    activity_name: '',
                    description: '',
                    location: '',
                    date_range: null,
                    start_time: null,
                    end_time: null,
                    ticket_price: '',
                    activity_type: null,
                    image: null
                };
                formRef.value?.restoreValidation();
            };

            return {
                formRef,
                formValue,
                activityTypes,
                rules,
                handleSubmit,
                handleMessage,
                handleBack,
                resetForm
            };
        },
        template: `
        <n-message-provider>
            <n-layout class="p-6" @mounted="handleMessage">
                <n-card class="mb-6">
                    <n-grid :cols="2">
                        <n-grid-item>
                            <h1 class="text-2xl font-bold mb-2">{{ page_title }}</h1>
                            <p class="text-gray-600">{{ page_description }}</p>
                        </n-grid-item>
                        <n-grid-item class="text-right">
                            <n-button type="default" @click="handleBack">
                                <template #icon>&#8592;</template>
                                ËøîÂõûÂàóË°®
                            </n-button>
                        </n-grid-item>
                    </n-grid>
                </n-card>

                <n-grid :x-gap="12" :cols="2">
                    <n-grid-item span="1">
                        <n-card title="Ê¥ªÂãïÂü∫Êú¨Ë≥áË®ä" class="mb-6">
                            <n-form ref="formRef" :model="formValue" :rules="rules">
                                <n-form-item label="Ê¥ªÂãïÂêçÁ®±" path="activity_name">
                                    <n-input
                                        v-model:value="formValue.activity_name"
                                        placeholder="Ë´ãËº∏ÂÖ•Ê¥ªÂãïÂêçÁ®±ÔºàÊúÄÂ§ö50Â≠óÔºâ"
                                        :maxlength="50"
                                        show-count
                                    />
                                </n-form-item>

                                <n-form-item label="Ë´ãËº∏ÂÖ•Ê¥ªÂãï‰ªãÁ¥π" path="description">
                                    <n-input
                                        v-model:value="formValue.description"
                                        type="textarea"
                                        placeholder="Ë´ãËº∏ÂÖ•Ê¥ªÂãï‰ªãÁ¥πÔºàÊúÄÂ§ö500Â≠óÔºâ"
                                        :rows="4"
                                        :maxlength="500"
                                        show-count
                                        :autosize="{ minRows: 4, maxRows: 8 }"
                                    />
                                </n-form-item>

                                <n-form-item label="Ê¥ªÂãïÂú∞Èªû" path="location">
                                    <n-input v-model:value="formValue.location" placeholder="Ë´ãËº∏ÂÖ•Ê¥ªÂãïÂú∞Èªû"/>
                                </n-form-item>

                                <n-grid :cols="2" :x-gap="12">
                                    <n-grid-item>
                                        <n-form-item label="Ê¥ªÂãïÊó•Êúü" path="date_range">
                                            <div style="max-width: 300px;">
                                                <n-date-picker
                                                    v-model:value="formValue.date_range"
                                                    type="daterange"
                                                    clearable
                                                    :disabled-date="(ts) => ts < Date.now() - 24 * 60 * 60 * 1000"
                                                    start-placeholder="ÈñãÂßãÊó•Êúü"
                                                    end-placeholder="ÁµêÊùüÊó•Êúü"
                                                    :default-time="['00:00:00', '23:59:59']"
                                                    style="width: 100%;"
                                                />
                                            </div>
                                        </n-form-item>
                                    </n-grid-item>
                                    <n-grid-item>
                                        <n-grid :cols="2" :x-gap="8">
                                            <n-grid-item>
                                                <n-form-item label="Ê¥ªÂãïËµ∑ÂßãÊôÇÈñì" path="start_time">
                                                    <n-time-picker
                                                        v-model:value="formValue.start_time"
                                                        clearable
                                                        format="HH:mm"
                                                        :minutes-step="5"
                                                        :minutes-options="[
                                                            '00', '05', '10', '15', '20', '25',
                                                            '30', '35', '40', '45', '50', '55'
                                                        ]"
                                                        :use-12-hours="false"
                                                        placement="top-start"
                                                        :is-hours-disabled="(hour) => false"
                                                        :is-minutes-disabled="(minute) => minute % 5 !== 0"
                                                        :actions="null"
                                                        style="width: 100%;"
                                                    />
                                                </n-form-item>
                                            </n-grid-item>
                                            <n-grid-item>
                                                <n-form-item label="Ê¥ªÂãïÁµêÊùüÊôÇÈñì" path="end_time">
                                                    <n-time-picker
                                                        v-model:value="formValue.end_time"
                                                        clearable
                                                        format="HH:mm"
                                                        :minutes-step="5"
                                                        :minutes-options="[
                                                            '00', '05', '10', '15', '20', '25',
                                                            '30', '35', '40', '45', '50', '55'
                                                        ]"
                                                        :use-12-hours="false"
                                                        placement="top-start"
                                                        :is-hours-disabled="(hour) => false"
                                                        :is-minutes-disabled="(minute) => minute % 5 !== 0"
                                                        :actions="null"
                                                        style="width: 100%;"
                                                    />
                                                </n-form-item>
                                            </n-grid-item>
                                        </n-grid>
                                    </n-grid-item>
                                </n-grid>
                            </n-form>
                        </n-card>
                    </n-grid-item>

                    <n-grid-item span="1">
                        <n-card title="Ê¥ªÂãïË©≥Á¥∞Ë®≠ÂÆö" class="mb-6">
                            <n-form ref="formRef" :model="formValue" :rules="rules">
                                <n-form-item label="Á•®ÂÉπË≥áË®ä">
                                    <n-input v-model:value="formValue.ticket_price" placeholder="Ë´ãËº∏ÂÖ•Á•®ÂÉπË≥áË®äÔºàËã•ÁÇ∫ÂÖçË≤ªÊ¥ªÂãïÂèØ‰∏çÂ°´Ôºâ"/>
                                </n-form-item>

                                <n-form-item label="Ê¥ªÂãïÈ°ûÂûã" path="activity_type">
                                    <n-select
                                        v-model:value="formValue.activity_type"
                                        :options="activityTypes"
                                        placeholder="Ë´ãÈÅ∏ÊìáÊ¥ªÂãïÈ°ûÂûã"
                                    />
                                </n-form-item>

                                <n-form-item label="Ê¥ªÂãïÂúñÁâá">
                                    <n-upload
                                        accept="image/*"
                                        :max="1"
                                        @change="handleImageUpload"
                                    >
                                        <n-button>‰∏äÂÇ≥ÂúñÁâá</n-button>
                                    </n-upload>
                                    <p class="text-sm text-gray-500 mt-2">Âª∫Ë≠∞Â∞∫ÂØ∏: 1200x630 ÂÉèÁ¥†ÔºåÊ™îÊ°àÂ§ßÂ∞è‰∏çË∂ÖÈÅé 2MB</p>
                                </n-form-item>

                                <div class="flex justify-between mt-6 space-x-12">
                                    <n-button type="primary" @click="handleSubmit" size="large">
                                        <template #icon>üíæ</template>
                                        Âª∫Á´ãÊ¥ªÂãï
                                    </n-button>
                                    <n-button type="error" @click="resetForm" size="large">
                                        <template #icon>üîÑ</template>
                                        ÈáçÁΩÆ
                                    </n-button>
                                </div>
                            </n-form>
                        </n-card>
                    </n-grid-item>
                </n-grid>
            </n-layout>
        </n-message-provider>
    `
    });

    app.mount('#app');
</script>
{% endblock %}