{% extends "admin-dashboard/base.html" %}

{% block title %}{{ page_title }}{% endblock %}

{% block extracss %}
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<link href="https://unpkg.com/naive-ui@2.34.4/dist/index.css" rel="stylesheet">
<script src="https://kit.fontawesome.com/your-kit-code.js" crossorigin="anonymous"></script>

<style>
    /* è¡¨å–®æ¨£å¼ */
    .n-form-item-label {
        font-weight: 500;
    }

    .n-input,
    .n-select,
    .n-date-picker {
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .n-button {
        transition: all 0.2s ease;
    }

    .n-button:hover {
        transform: translateY(-1px);
    }
</style>
{% endblock %}

{% block content %}
<!-- CSRFä»¤ç‰Œ -->
{% csrf_token %}

<div id="app" class="wrapper wrapper-content animated fadeInRight">
    <!-- Vue æ‡‰ç”¨å°‡åœ¨é€™è£¡æ¸²æŸ“ -->
</div>

<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="https://unpkg.com/naive-ui@2.34.4/dist/index.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
    // å®šç¾© Django è®Šé‡ç‚º JavaScript è®Šé‡
    const djangoPageTitle = "{{ page_title }}";
    const djangoPageDescription = "{{ page_description }}";

    const { createApp, ref, computed, onMounted } = Vue;
    const {
        NLayout, NCard, NForm, NFormItem, NInput, NDatePicker, NTimePicker,
        NSelect, NUpload, NButton, NGrid, NGridItem, NSpace, NMessageProvider,
        useMessage
    } = naive;

    const app = createApp({
        components: {
            NLayout, NCard, NForm, NFormItem, NInput, NDatePicker, NTimePicker,
            NSelect, NUpload, NButton, NGrid, NGridItem, NSpace, NMessageProvider
        },
        setup() {
            // é é¢æ¨™é¡Œå’Œæè¿°
            const pageTitle = ref(djangoPageTitle || 'ç·¨è¼¯æ´»å‹•');
            const pageDescription = ref(djangoPageDescription || 'ç·¨è¼¯ç¾æœ‰æ´»å‹•è³‡æ–™');

            // è¡¨å–®èˆ‡è¨Šæ¯ç›¸é—œåƒè€ƒ
            const formRef = ref(null);
            const message = ref(null);

            // ç²å–ç•¶å‰æ´»å‹•IDï¼ˆå¾URLä¸­ç²å–ï¼‰
            const eventId = "{{ event_id }}";

            // è¨Šæ¯ç³»çµ±åˆå§‹åŒ–
            const initMessageSystem = () => {
                if (message.value === null) {
                    message.value = useMessage();
                    console.log('è¨Šæ¯ç³»çµ±åˆå§‹åŒ–å®Œæˆ');
                }
                return message.value;
            };

            // å…ƒä»¶æ›è¼‰åˆå§‹åŒ–
            const initComponent = () => {
                setTimeout(initMessageSystem, 100);
            };

            // è¿”å›åˆ—è¡¨é é¢
            const handleBack = () => {
                window.location.href = '/admin-dashboard/entertainment/activities/';
            };

            // è¡¨å–®è³‡æ–™
            const formValue = ref({
                activity_name: '',
                description: '',
                location: '',
                address: '',
                organizer: '',
                source_url: '',
                date_range: null,
                start_time: null,
                end_time: null,
                ticket_price: '',
                activity_type: null,
                image: null,
                imageFile: null,
                original_image_url: '' // å„²å­˜åŸå§‹åœ–ç‰‡URL
            });

            // æ´»å‹•é¡å‹é¸é …
            const activityTypes = [
                { label: 'å±•è¦½', value: 'å±•è¦½' },
                { label: 'è¡¨æ¼”', value: 'è¡¨æ¼”' },
                { label: 'éŸ³æ¨‚æœƒ', value: 'éŸ³æ¨‚æœƒ' },
                { label: 'æˆ²åŠ‡', value: 'æˆ²åŠ‡' },
                { label: 'å…¶ä»–', value: 'å…¶ä»–' }
            ];

            // è¡¨å–®é©—è­‰è¦å‰‡
            const rules = {
                activity_name: {
                    required: true,
                    message: 'è«‹è¼¸å…¥æ´»å‹•åç¨±',
                    trigger: 'blur',
                    validator: (rule, value) => {
                        if (value && value.length > 30) {
                            return new Error('æ´»å‹•åç¨±ä¸èƒ½è¶…é30å­—');
                        }
                        return true;
                    }
                },
                description: {
                    required: true,
                    message: 'è«‹è¼¸å…¥æ´»å‹•ä»‹ç´¹',
                    trigger: 'blur',
                    validator: (rule, value) => {
                        if (value && value.length > 500) {
                            return new Error('æ´»å‹•ä»‹ç´¹ä¸èƒ½è¶…é500å­—');
                        }
                        return true;
                    }
                },
                location: {
                    required: true,
                    message: 'è«‹è¼¸å…¥æ´»å‹•åœ°é»',
                    trigger: 'blur'
                },
                date_range: {
                    required: true,
                    message: 'è«‹é¸æ“‡æ´»å‹•æ—¥æœŸç¯„åœ',
                    trigger: 'blur',
                    validator: (rule, value) => {
                        if (!value || !value[0] || !value[1]) {
                            return new Error('è«‹é¸æ“‡å®Œæ•´çš„æ—¥æœŸç¯„åœ');
                        }
                        return true;
                    }
                },
                activity_type: {
                    required: true,
                    message: 'è«‹é¸æ“‡æ´»å‹•é¡å‹',
                    trigger: 'change'
                },
                address: {
                    required: true,
                    message: 'è«‹è¼¸å…¥æ´»å‹•è©³ç´°åœ°å€',
                    trigger: 'blur'
                },
                organizer: {
                    required: true,
                    message: 'è«‹è¼¸å…¥ä¸»è¾¦å–®ä½åç¨±',
                    trigger: 'blur'
                }
            };

            // ===== åœ–ç‰‡è™•ç† =====
            // è™•ç†åœ–ç‰‡ä¸Šå‚³
            const handleImageUpload = (options) => {
                const { file } = options;
                if (file.file) {
                    // ä¿å­˜æª”æ¡ˆç‰©ä»¶
                    formValue.value.imageFile = file.file;

                    // å»ºç«‹é è¦½ç”¨çš„ base64
                    const reader = new FileReader();
                    reader.readAsDataURL(file.file);
                    reader.onload = () => {
                        formValue.value.image = reader.result;
                    };
                }
            };

            // åœ–ç‰‡é è¦½ç‹€æ…‹
            const showImagePreview = computed(() => Boolean(formValue.value.image || formValue.value.original_image_url));

            // ç²å–åœ–ç‰‡é¡¯ç¤ºURL
            const displayImageUrl = computed(() => formValue.value.image || formValue.value.original_image_url);

            // ===== è³‡æ–™åŠ è¼‰èˆ‡è™•ç† =====
            // åŠ è¼‰æ´»å‹•æ•¸æ“š
            const loadEventData = async () => {
                try {
                    console.log(`æ­£åœ¨åŠ è¼‰æ´»å‹•ID: ${eventId} çš„æ•¸æ“š`);
                    // ä½¿ç”¨åŸºæ–¼æ•¸æ“šåº«IDæŸ¥è©¢çš„APIç«¯é»
                    const response = await axios.get(`/admin-dashboard/entertainment/activities/api/id/${eventId}/`);
                    console.log('APIè¿”å›æ•¸æ“š:', response.data);

                    // æª¢æŸ¥å’Œæå–APIè¿”å›çš„æ•¸æ“š
                    let eventData;
                    if (response.data.status === 'success' && response.data.data) {
                        eventData = response.data.data;
                        console.log('æˆåŠŸæå–æ´»å‹•æ•¸æ“š:', eventData);
                    } else {
                        eventData = response.data;
                        console.log('ç›´æ¥ä½¿ç”¨è¿”å›æ•¸æ“š:', eventData);
                    }

                    // è™•ç†æ—¥æœŸæ™‚é–“
                    const { startDate, startTime, endDate, endTime } = parseDateTimeData(eventData);

                    // è¨­ç½®è¡¨å–®å€¼
                    formValue.value = {
                        ...formValue.value,
                        activity_name: eventData.activity_name || '',
                        description: eventData.description || '',
                        location: eventData.location || '',
                        address: eventData.address || '',
                        organizer: eventData.organizer || '',
                        source_url: eventData.source_url || '',
                        date_range: (startDate && endDate) ? [startDate, endDate] : null,
                        start_time: startTime,
                        end_time: endTime,
                        ticket_price: eventData.ticket_price || '',
                        activity_type: eventData.activity_type || null,
                        image: null,
                        imageFile: null,
                        original_image_url: eventData.image_url || ''
                    };

                    const msgSystem = initMessageSystem();
                    msgSystem.success('æ´»å‹•è³‡æ–™è¼‰å…¥æˆåŠŸ');
                } catch (error) {
                    console.error('åŠ è¼‰æ´»å‹•æ•¸æ“šå¤±æ•—:', error);
                    console.error('è©³ç´°éŒ¯èª¤:', error.response || error.message);

                    const msgSystem = initMessageSystem();
                    msgSystem.error(`åŠ è¼‰æ´»å‹•æ•¸æ“šå¤±æ•—: ${error.response?.data?.message || error.message}`);
                }
            };

            // è§£ææ—¥æœŸæ™‚é–“æ•¸æ“š
            const parseDateTimeData = (eventData) => {
                let startDate = null;
                let startTime = null;
                let endDate = null;
                let endTime = null;

                console.log('è™•ç†æ—¥æœŸæ™‚é–“ - é–‹å§‹æ—¥æœŸæ™‚é–“:', eventData.start_date);
                console.log('è™•ç†æ—¥æœŸæ™‚é–“ - çµæŸæ—¥æœŸæ™‚é–“:', eventData.end_date);

                // å¦‚æœæœ‰é–‹å§‹æ—¥æœŸæ™‚é–“ï¼Œè§£æç‚ºæ—¥æœŸèˆ‡æ™‚é–“éƒ¨åˆ†
                if (eventData.start_date) {
                    try {
                        const startDateTime = new Date(eventData.start_date);
                        startDate = new Date(
                            startDateTime.getFullYear(),
                            startDateTime.getMonth(),
                            startDateTime.getDate()
                        );
                        startTime = startDateTime; // æ™‚é–“é¸æ“‡å™¨å¯ä»¥ä½¿ç”¨å®Œæ•´æ—¥æœŸå°è±¡
                        console.log('è§£æé–‹å§‹æ—¥æœŸ:', startDate);
                        console.log('è§£æé–‹å§‹æ™‚é–“:', startTime);
                    } catch (error) {
                        console.error('è§£æé–‹å§‹æ—¥æœŸæ™‚é–“å‡ºéŒ¯:', error);
                        initMessageSystem().warning('è§£æé–‹å§‹æ—¥æœŸæ™‚é–“å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¨­ç½®');
                    }
                }

                // å¦‚æœæœ‰çµæŸæ—¥æœŸæ™‚é–“ï¼Œè§£æç‚ºæ—¥æœŸèˆ‡æ™‚é–“éƒ¨åˆ†
                if (eventData.end_date) {
                    try {
                        const endDateTime = new Date(eventData.end_date);
                        endDate = new Date(
                            endDateTime.getFullYear(),
                            endDateTime.getMonth(),
                            endDateTime.getDate()
                        );
                        endTime = endDateTime; // æ™‚é–“é¸æ“‡å™¨å¯ä»¥ä½¿ç”¨å®Œæ•´æ—¥æœŸå°è±¡
                        console.log('è§£æçµæŸæ—¥æœŸ:', endDate);
                        console.log('è§£æçµæŸæ™‚é–“:', endTime);
                    } catch (error) {
                        console.error('è§£æçµæŸæ—¥æœŸæ™‚é–“å‡ºéŒ¯:', error);
                        initMessageSystem().warning('è§£æçµæŸæ—¥æœŸæ™‚é–“å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¨­ç½®');
                    }
                }

                return { startDate, startTime, endDate, endTime };
            };

            // åœ¨çµ„ä»¶æ›è¼‰å¾ŒåŠ è¼‰æ•¸æ“š
            onMounted(() => {
                loadEventData();
            });

            // ===== è¡¨å–®è™•ç† =====
            // æ ¼å¼åŒ–æ—¥æœŸæ™‚é–“
            const formatDateTime = () => {
                let startDateTime = null;
                let endDateTime = null;

                // è™•ç†é–‹å§‹æ—¥æœŸæ™‚é–“
                if (formValue.value.date_range && formValue.value.date_range[0]) {
                    const startDate = formValue.value.date_range[0];

                    if (formValue.value.start_time) {
                        // å»ºç«‹åˆä½µçš„æ—¥æœŸæ™‚é–“å°è±¡
                        const dateObj = new Date(startDate);
                        const timeObj = new Date(formValue.value.start_time);

                        dateObj.setHours(timeObj.getHours());
                        dateObj.setMinutes(timeObj.getMinutes());

                        // æ ¼å¼åŒ–ç‚º YYYY-MM-DD HH:MM:SS
                        startDateTime = dateObj.toISOString().slice(0, 19).replace('T', ' ');
                    } else {
                        // å¦‚æœæ²’æœ‰æ™‚é–“ï¼Œä½¿ç”¨ 00:00:00
                        startDateTime = `${startDate.toISOString().split('T')[0]} 00:00:00`;
                    }
                }

                // è™•ç†çµæŸæ—¥æœŸæ™‚é–“
                if (formValue.value.date_range && formValue.value.date_range[1]) {
                    const endDate = formValue.value.date_range[1];

                    if (formValue.value.end_time) {
                        // å»ºç«‹åˆä½µçš„æ—¥æœŸæ™‚é–“å°è±¡
                        const dateObj = new Date(endDate);
                        const timeObj = new Date(formValue.value.end_time);

                        dateObj.setHours(timeObj.getHours());
                        dateObj.setMinutes(timeObj.getMinutes());

                        // æ ¼å¼åŒ–ç‚º YYYY-MM-DD HH:MM:SS
                        endDateTime = dateObj.toISOString().slice(0, 19).replace('T', ' ');
                    } else {
                        // å¦‚æœæ²’æœ‰æ™‚é–“ï¼Œä½¿ç”¨ 23:59:59
                        endDateTime = `${endDate.toISOString().split('T')[0]} 23:59:59`;
                    }
                }

                return { startDateTime, endDateTime };
            };

            // ç²å– CSRF ä»¤ç‰Œ
            const getCsrfToken = () => {
                let csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
                if (!csrfToken) {
                    const csrfCookie = document.cookie
                        .split('; ')
                        .find(row => row.startsWith('csrftoken='));
                    if (csrfCookie) {
                        csrfToken = csrfCookie.split('=')[1];
                    }
                }
                console.log('ä½¿ç”¨çš„CSRFä»¤ç‰Œ:', csrfToken);
                return csrfToken;
            };

            // é¡¯ç¤ºæ“ä½œçµæœè¨Šæ¯
            const showResultMessage = (success, data) => {
                // ç¢ºä¿è¨Šæ¯ç³»çµ±å·²åˆå§‹åŒ–
                const msgInstance = initMessageSystem();
                const activityName = data.activity_name || formValue.value.activity_name || 'æ­¤æ´»å‹•';
                const redirectUrl = data.redirect_url || `${window.location.origin}/admin-dashboard/entertainment/activities/`;

                // æˆåŠŸè¨Šæ¯å…§å®¹
                const successTitle = `æ´»å‹•ã€Œ${activityName}ã€æ›´æ–°æˆåŠŸï¼`;
                const successContent = `æ´»å‹•ID: ${data.id}`;

                if (success) {
                    // ä½¿ç”¨ Naive UI è¨Šæ¯ç³»çµ±
                    try {
                        msgInstance.success({
                            content: `${successTitle} ID: ${data.id}`,
                            duration: 3000,
                            closable: true
                        });
                    } catch (e) {
                        console.error('Naive UI è¨Šæ¯é¡¯ç¤ºå¤±æ•—:', e);
                    }

                    // ä½¿ç”¨ç€è¦½å™¨å…§å»º alert ä½œç‚ºå‚™ç”¨
                    alert(`${successTitle}\n\n${successContent}`);

                    // è©¢å•ç”¨æˆ¶å¾ŒçºŒå‹•ä½œ
                    const confirmed = confirm('æ˜¯å¦è¿”å›æ´»å‹•åˆ—è¡¨ï¼Ÿ');
                    if (confirmed) {
                        window.location.href = redirectUrl;
                    }
                } else {
                    // éŒ¯èª¤è¨Šæ¯
                    try {
                        msgInstance.error(data.message || 'æ“ä½œå¤±æ•—');
                    } catch (e) {
                        alert(`æ“ä½œå¤±æ•—: ${data.message || 'æœªçŸ¥éŒ¯èª¤'}`);
                    }
                }
            };

            // æäº¤è¡¨å–®è™•ç†
            const handleSubmit = async (e) => {
                e.preventDefault();
                try {
                    // è¡¨å–®é©—è­‰
                    await formRef.value?.validate();

                    // ç²å–åˆä½µçš„æ—¥æœŸæ™‚é–“
                    const { startDateTime, endDateTime } = formatDateTime();
                    console.log('åˆä½µå¾Œçš„é–‹å§‹æ—¥æœŸæ™‚é–“:', startDateTime);
                    console.log('åˆä½µå¾Œçš„çµæŸæ—¥æœŸæ™‚é–“:', endDateTime);

                    // æª¢æŸ¥å¿…è¦æ¬„ä½
                    const requiredFields = ['activity_name', 'address', 'organizer', 'description', 'location'];

                    // å‰µå»º FormData ç”¨æ–¼æäº¤
                    const formData = new FormData();

                    // æº–å‚™è¦ç™¼é€çš„æ•¸æ“š
                    const submitData = {
                        activity_name: formValue.value.activity_name,
                        description: formValue.value.description,
                        organizer: formValue.value.organizer || '',
                        address: formValue.value.address || '',
                        location: formValue.value.location,
                        start_date: startDateTime,
                        end_date: endDateTime,
                        latitude: null,
                        longitude: null,
                        ticket_price: formValue.value.ticket_price || '',
                        source_url: formValue.value.source_url || '',
                        original_image_url: formValue.value.original_image_url || ''
                    };

                    console.log('æº–å‚™æäº¤çš„æ•¸æ“š:', submitData);

                    // é©—è­‰å¿…å¡«æ¬„ä½
                    for (const field of requiredFields) {
                        if (!submitData[field]) {
                            throw new Error(`${field} æ˜¯å¿…å¡«æ¬„ä½`);
                        }
                    }

                    // å°‡æ•¸æ“šæ·»åŠ åˆ° FormData
                    Object.keys(submitData).forEach(key => {
                        formData.append(key, submitData[key]);
                    });

                    // å¦‚æœæœ‰æ–°ä¸Šå‚³åœ–ç‰‡ï¼Œæ·»åŠ åˆ° FormData
                    if (formValue.value.imageFile) {
                        formData.append('image', formValue.value.imageFile);
                    }

                    // ç²å– CSRF ä»¤ç‰Œ
                    const csrfToken = getCsrfToken();

                    // ç™¼é€ API è«‹æ±‚
                    try {
                        const response = await axios({
                            method: 'put', // ä½¿ç”¨PUTæ–¹æ³•
                            url: `/admin-dashboard/entertainment/activities/update/${eventId}/`,
                            data: formData,
                            headers: {
                                'X-CSRFToken': csrfToken,
                                'Content-Type': 'multipart/form-data'
                            }
                        });

                        console.log('Response:', response.data);

                        if (response.data.status === 'success') {
                            // è¨˜éŒ„æˆåŠŸä¿¡æ¯
                            console.log('æ´»å‹•æ›´æ–°æˆåŠŸï¼Œæ´»å‹•ID:', response.data.id);

                            // é¡¯ç¤ºæˆåŠŸè¨Šæ¯ä¸¦è™•ç†å¾ŒçºŒå‹•ä½œ
                            showResultMessage(true, response.data);
                        } else {
                            throw new Error(response.data.message || 'æ›´æ–°æ´»å‹•å¤±æ•—');
                        }
                    } catch (error) {
                        console.error('API Error:', error.response?.data || error);
                        showResultMessage(false, {
                            message: error.response?.data?.message || error.message || 'æ›´æ–°æ´»å‹•å¤±æ•—'
                        });
                    }
                } catch (error) {
                    console.error('Form Error:', error);
                    showResultMessage(false, { message: error.message || 'è¡¨å–®é©—è­‰å¤±æ•—' });
                }
            };

            // é‡ç½®è¡¨å–®
            const resetForm = () => {
                // é‡æ–°è¼‰å…¥åŸå§‹æ•¸æ“š
                loadEventData();
                initMessageSystem().info('è¡¨å–®å·²é‡ç½®ç‚ºåŸå§‹æ•¸æ“š');
            };

            return {
                formRef,
                formValue,
                activityTypes,
                rules,
                handleSubmit,
                handleBack,
                resetForm,
                handleImageUpload,
                showImagePreview,
                displayImageUrl,
                initMessageSystem,
                initComponent,
                pageTitle,
                pageDescription
            };
        },
        template: `
        <n-message-provider>
            <n-layout class="p-6" @mounted="initComponent">
                <div ref="mountHook"></div>
                <n-card class="mb-6">
                    <n-grid :cols="2">
                        <n-grid-item>
                            <h1 class="text-2xl font-bold mb-2">[[pageTitle]]</h1>
                            <p class="text-gray-600">[[pageDescription]]</p>
                        </n-grid-item>
                        <n-grid-item class="text-right">
                            <n-button type="default" @click="handleBack">
                                <template #icon>&#8592;</template>
                                è¿”å›åˆ—è¡¨
                            </n-button>
                        </n-grid-item>
                    </n-grid>
                </n-card>

                <n-grid :x-gap="12" :cols="2">
                    <n-grid-item span="1">
                        <n-card title="æ´»å‹•åŸºæœ¬è³‡è¨Š" class="mb-6">
                            <n-form ref="formRef" :model="formValue" :rules="rules">
                                <n-form-item label="æ´»å‹•åç¨±" path="activity_name">
                                    <n-input
                                        v-model:value="formValue.activity_name"
                                        placeholder="è«‹è¼¸å…¥æ´»å‹•åç¨±ï¼ˆæœ€å¤š30å­—ï¼‰"
                                        :maxlength="30"
                                        show-count
                                    />
                                </n-form-item>

                                <n-form-item label="ä¸»è¾¦å–®ä½" path="organizer">
                                    <n-input
                                        v-model:value="formValue.organizer"
                                        placeholder="è«‹è¼¸å…¥ä¸»è¾¦å–®ä½åç¨±"
                                    />
                                </n-form-item>

                                <n-form-item label="è«‹è¼¸å…¥æ´»å‹•ä»‹ç´¹" path="description">
                                    <n-input
                                        v-model:value="formValue.description"
                                        type="textarea"
                                        placeholder="è«‹è¼¸å…¥æ´»å‹•ä»‹ç´¹ï¼ˆæœ€å¤š500å­—ï¼‰"
                                        :rows="4"
                                        :maxlength="500"
                                        show-count
                                        :autosize="{ minRows: 4, maxRows: 8 }"
                                    />
                                </n-form-item>

                                <n-form-item label="æ´»å‹•åœ°é»" path="location">
                                    <n-input v-model:value="formValue.location" placeholder="è«‹è¼¸å…¥æ´»å‹•åœ°é»"/>
                                </n-form-item>

                                <n-form-item label="æ´»å‹•è©³ç´°åœ°å€" path="address">
                                    <n-input v-model:value="formValue.address" placeholder="è«‹è¼¸å…¥æ´»å‹•è©³ç´°åœ°å€"/>
                                </n-form-item>

                                <n-grid :cols="2" :x-gap="12">
                                    <n-grid-item>
                                        <n-form-item label="æ´»å‹•æ—¥æœŸ" path="date_range">
                                            <div style="max-width: 300px;">
                                                <n-date-picker
                                                    v-model:value="formValue.date_range"
                                                    type="daterange"
                                                    clearable
                                                    start-placeholder="é–‹å§‹æ—¥æœŸ"
                                                    end-placeholder="çµæŸæ—¥æœŸ"
                                                    :default-time="['00:00:00', '23:59:59']"
                                                    style="width: 100%;"
                                                />
                                            </div>
                                        </n-form-item>
                                    </n-grid-item>
                                    <n-grid-item>
                                        <n-grid :cols="2" :x-gap="8">
                                            <n-grid-item>
                                                <n-form-item label="æ´»å‹•èµ·å§‹æ™‚é–“" path="start_time">
                                                    <n-time-picker
                                                        v-model:value="formValue.start_time"
                                                        clearable
                                                        format="HH:mm"
                                                        :minutes-step="5"
                                                        :minutes-options="[
                                                            '00', '05', '10', '15', '20', '25',
                                                            '30', '35', '40', '45', '50', '55'
                                                        ]"
                                                        :use-12-hours="false"
                                                        placement="top-start"
                                                        :is-hours-disabled="(hour) => false"
                                                        :is-minutes-disabled="(minute) => minute % 5 !== 0"
                                                        :actions="null"
                                                        style="width: 100%;"
                                                    />
                                                </n-form-item>
                                            </n-grid-item>
                                            <n-grid-item>
                                                <n-form-item label="æ´»å‹•çµæŸæ™‚é–“" path="end_time">
                                                    <n-time-picker
                                                        v-model:value="formValue.end_time"
                                                        clearable
                                                        format="HH:mm"
                                                        :minutes-step="5"
                                                        :minutes-options="[
                                                            '00', '05', '10', '15', '20', '25',
                                                            '30', '35', '40', '45', '50', '55'
                                                        ]"
                                                        :use-12-hours="false"
                                                        placement="top-start"
                                                        :is-hours-disabled="(hour) => false"
                                                        :is-minutes-disabled="(minute) => minute % 5 !== 0"
                                                        :actions="null"
                                                        style="width: 100%;"
                                                    />
                                                </n-form-item>
                                            </n-grid-item>
                                        </n-grid>
                                    </n-grid-item>
                                </n-grid>
                            </n-form>
                        </n-card>
                    </n-grid-item>

                    <n-grid-item span="1">
                        <n-card title="æ´»å‹•è©³ç´°è¨­å®š" class="mb-6">
                            <n-form ref="formRef" :model="formValue" :rules="rules">
                                <n-form-item label="ç¥¨åƒ¹è³‡è¨Š">
                                    <n-input v-model:value="formValue.ticket_price" placeholder="è«‹è¼¸å…¥ç¥¨åƒ¹è³‡è¨Šï¼ˆè‹¥ç‚ºå…è²»æ´»å‹•å¯ä¸å¡«ï¼‰"/>
                                </n-form-item>

                                <n-form-item label="æ´»å‹•é¡å‹" path="activity_type">
                                    <n-select
                                        v-model:value="formValue.activity_type"
                                        :options="activityTypes"
                                        placeholder="è«‹é¸æ“‡æ´»å‹•é¡å‹"
                                    />
                                </n-form-item>

                                <n-form-item label="æ´»å‹•ç¶²å€" path="source_url">
                                    <n-input v-model:value="formValue.source_url" placeholder="è«‹è¼¸å…¥æ´»å‹•å®˜æ–¹ç¶²å€"/>
                                </n-form-item>

                                <n-form-item label="æ´»å‹•åœ–ç‰‡">
                                    <n-upload
                                        accept="image/*"
                                        :max="1"
                                        @change="handleImageUpload"
                                        list-type="image-card"
                                    >
                                        <n-button>ä¸Šå‚³æ–°åœ–ç‰‡</n-button>
                                    </n-upload>
                                    <p class="text-sm text-gray-500 mt-2">å»ºè­°å°ºå¯¸: 1200x630 åƒç´ ï¼Œæª”æ¡ˆå¤§å°ä¸è¶…é 2MBï¼Œä¸Šå‚³æ–°åœ–ç‰‡å°‡æ›¿æ›åŸæœ‰åœ–ç‰‡</p>
                                </n-form-item>

                                <!-- åœ–ç‰‡é è¦½å€åŸŸ -->
                                <div v-if="showImagePreview" class="mb-6 mt-2 border-t pt-4 border-gray-200">
                                    <h3 class="text-lg font-medium text-gray-700 mb-3">
                                        [[formValue.image ? 'æ–°ä¸Šå‚³åœ–ç‰‡é è¦½' : 'ç¾æœ‰åœ–ç‰‡']]
                                    </h3>
                                    <div class="bg-gray-50 p-4 rounded-lg shadow-sm">
                                        <p class="text-xs text-gray-500 text-left mt-2">
                                            [[formValue.image ? 'ä¸Šå‚³çš„æ–°åœ–ç‰‡å°‡æ›¿æ›åŸæœ‰åœ–ç‰‡' : 'ç›®å‰ä½¿ç”¨çš„åœ–ç‰‡']]
                                        </p>
                                        <img :src="displayImageUrl" class="mx-auto" style="max-width: 100%; max-height: 300px; object-fit: contain;" />
                                    </div>
                                </div>

                                <div class="flex justify-between mt-6 space-x-12">
                                    <n-button type="primary" @click="handleSubmit" size="large">
                                        <template #icon>ğŸ’¾</template>
                                        æ›´æ–°æ´»å‹•
                                    </n-button>
                                    <n-button type="warning" @click="resetForm" size="large">
                                        <template #icon>ğŸ”„</template>
                                        é‚„åŸè®Šæ›´
                                    </n-button>
                                </div>
                            </n-form>
                        </n-card>
                    </n-grid-item>
                </n-grid>
            </n-layout>
        </n-message-provider>
    `
    });

    // è¨­å®šVueåˆ†éš”ç¬¦è™Ÿ
    app.config.compilerOptions.delimiters = ['[[', ']]'];

    app.mount('#app');
</script>
{% endblock %}